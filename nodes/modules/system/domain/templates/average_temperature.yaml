# Template Sensors
template:
- sensor:
  - name: "Average System Temperature"
    unit_of_measurement: "°C"
    state: >
      {% set entity_ids = states | selectattr('entity_id', 'search', 'temperature') | map(attribute='entity_id') | list %} 
      {% set valid_temps = namespace(count=0, total=0) %} 
      {% for entity_id in entity_ids %}
        {% if 'sensor.' not in entity_id %}{% continue %}{% endif %}
        {% if 'humidity' in entity_id or 'battery' in entity_id or 'average' in entity_id%}{% continue %}{% endif %}
        {{entity_id}}
        {% set state = states(entity_id) %}
        {% if state == 'unavailable' %}{% continue %}{% endif %}
        {% set temp = state | float %}
        {% if temp is not none %}
          {% set valid_temps.count = valid_temps.count + 1 %}
          {% set valid_temps.total = valid_temps.total + temp %}
        {% endif %}
      {% endfor %}
      {% if valid_temps.count > 0 %}
        {{ (valid_temps.total / valid_temps.count) | round(1) }}
      {% else %}
        Unavailable
      {% endif %}

# - sensor:
#     - name: "Average System Temperature2"
#       unit_of_measurement: "°C"
#       state: >
#         {% set valid_temps = namespace(count=0, total=0) %}
#         {% for entity_id, state in states.items() %}
#           {% if 'sensor.' not in entity_id %}
#             {% continue %}
#           {% endif %}
#           {% if 'humidity' in entity_id or 'battery' in entity_id or 'average' in entity_id %}
#             {% continue %}
#           {% endif %}
#           {% if state == 'unavailable' %}
#             {% continue %}
#           {% endif %}
#           {% set temp = state.state | float %}
#           {% if temp is not none %}
#             {% set valid_temps.count = valid_temps.count + 1 %}
#             {% set valid_temps.total = valid_temps.total + temp %}
#           {% endif %}
#         {% endfor %}
#         {% if valid_temps.count > 0 %}
#           {{ (valid_temps.total / valid_temps.count) | round(1) }}
#         {% else %}
#           Unavailable
#         {% endif %}
